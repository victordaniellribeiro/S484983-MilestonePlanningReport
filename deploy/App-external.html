<!DOCTYPE html>
<html>
<head>
    <title>S484983-MilestonePlanningReport</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",requires:["Rally.ui.gridboard.plugin.GridBoardCustomFilterControl"],_cardBoard:void 0,_filters:void 0,_types:["PortfolioItem/Feature"],_initDate:void 0,_endDate:void 0,_milestoneType:void 0,_selectedMilestones:void 0,_filterPlannedStartDate:void 0,_filterPlannedEndDate:void 0,_filterParent:void 0,_filterParentFormattedID:void 0,_filterProject:void 0,_exportData:void 0,_exportButton:void 0,_projectStore:void 0,_myMask:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"hbox"},height:"90%",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;console.log("project:",e),this.projectId=e;Ext.create("Rally.data.WsapiDataStore",{model:"Project",limit:1/0,fetch:["Name","ObjectID"],autoLoad:!0,sorters:[{property:"Name",direction:"ASC"}],filters:Rally.data.QueryFilter.or([{property:"Parent.ObjectID",value:e},Rally.data.QueryFilter.or([{property:"Parent.parent.ObjectID",value:e},{property:"Parent.parent.parent.ObjectID",value:e}])]),listeners:{load:function(e,t,r){console.log("projects",t);var i=[];i.push({_refName:"-- No Entry --",Name:""}),_.each(t,function(e){i.push({_refName:e.get("Name"),Name:e.get("Name")})});var o=Ext.create("Ext.data.Store",{fields:["_refName","Name"],data:i});console.log("projectStore:",o),this._updateCombo(o),this._buildGrid()},scope:this}})},_buildGrid:function(){this._milestoneComboStore=void 0,this._milestoneCombo=Ext.widget("rallymilestonecombobox",{itemId:"milestonecombobox",allowClear:!0,multiSelect:!0,queryMode:"local",width:300,listeners:{afterrender:function(e){e.disable()},beforerender:function(e){console.log("beforerender: ",e),this._blockFilters()},ready:function(e){console.log("ready: ",e.value),this._unBlockFilters(),e.refreshStore(),e.enable()},change:function(e){if(console.log("change: ",e.getValue()),e.getValue()&&""!=e.getValue()&&e.valueModels.length>0){var t=e.valueModels;t.sort(function(e,t){return e.get("TargetDate").getTime()-t.get("TargetDate").getTime()}),this._selectedMilestones=t,this._doSearch(t)}else this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}}),this._milestoneComboStore=this._milestoneCombo.getStore(),this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Choose date range for milestone:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(e,t,r){this._initDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(e,t,r){this._endDate=t;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"rallyfieldvaluecombobox",fieldLabel:"Milestone Types",model:"Milestone",field:"c_Type",scope:this,listeners:{change:function(e){console.log("Milestone type: ",e.getValue()),this._milestoneType=e.getValue(),this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this,this._milestoneType)},scope:this}},{xtype:"rallycheckboxfield",fieldLabel:"Extra Filters:",itemId:"extraFilters",listeners:{change:function(e,t,r){console.log("value check:",t),t?this._showExtraFilters():this._hideExtraFilters()},scope:this}},{xtype:"panel",itemId:"extraFiltersPanel",layout:"hbox",hidden:!0,align:"stretch",bodyPadding:10,items:[{xtype:"datefield",fieldLabel:"Planned Start Date",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,r){this._filterPlannedStartDate=t},scope:this}},{xtype:"datefield",fieldLabel:"Planned End Date",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,r){this._filterPlannedEndDate=t},scope:this}},{xtype:"rallytextfield",fieldLabel:"Parent",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,r){this._filterParent=t,console.log("filter parent:",this._filterParent)},scope:this}},{xtype:"rallytextfield",fieldLabel:"Parent ID",margin:"0 15 0 0",scope:this,listeners:{change:function(e,t,r){this._filterParentFormattedID=t,console.log("filter parent FormattedID:",this._filterParentFormattedID)},scope:this}},{xtype:"combobox",fieldLabel:"Project",store:this._projectStore,queryMode:"local",displayField:"_refName",valueField:"Name",margin:"0 15 0 0",anyMatch:!0,listeners:{select:function(e,t){console.log("project: ",e.getValue()),this._filterProject=e.getValue()},scope:this},scope:this},{xtype:"rallybutton",text:"Apply Filter",margin:"0 15 0 0",scope:this,handler:function(){console.log("Apply filter",this._selectedMilestones),this._selectedMilestones&&this._doSearch(this._selectedMilestones)}}]}]}]},{xtype:"fieldcontainer",fieldLabel:"Milestone",pack:"end",labelAlign:"right",items:[this._milestoneCombo]}])},_blockFilters:function(){this.down("#header").disable()},_unBlockFilters:function(){this.down("#header").enable()},_hideExtraFilters:function(){this.down("#extraFiltersPanel").hide()},_showExtraFilters:function(){this.down("#extraFiltersPanel").show()},_updateCombo:function(e){void 0===this._projectStore&&(this._projectStore=e)},_doSearch:function(e){this.setLoading(),this.down("#bodyContainer").removeAll(!0),this._exportData=new Ext.util.MixedCollection;var t=[];for(var r of e)t.push(this._buildMilestoneColumn(r));Deft.Promise.all(t).then({success:function(e){this.setLoading(!1);var t=this._convertExportDataToJson(this._exportData);this._exportButton?(this.down("#header").remove(this._exportButton),this._exportButton=this._createExportButton(t),this.down("#header").add(this._exportButton)):(this._exportButton=this._createExportButton(t),this.down("#header").add(this._exportButton))},scope:this})},_createExportButton:function(e){return Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var t=this._convertToCSV(e);console.log("converting to csv:",t);var r=document.createElement("a"),i=new Blob(["\ufeff",t]),o=URL.createObjectURL(i);r.href=o,r.download="report.csv",document.body.appendChild(r),r.click(),document.body.removeChild(r)}})},_applyMilestoneRangeFilter:function(e,t,r,i,o){!e||t||o?!t||e||o?e&&t&&!o?this._milestoneComboStore.filterBy(function(r){if(r.get("TargetDate")&&r.get("TargetDate").getTime()>e.getTime()&&r.get("TargetDate").getTime()<t.getTime())return r},i):e&&!t&&o?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()>e.getTime()&&t.get("c_Type")===this._milestoneType)return t},i):!e&&t&&o?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()<e.getTime()&&t.get("c_Type")===this._milestoneType)return t},i):e||t||!o?t&&e&&o?this._milestoneComboStore.filterBy(function(r){if(r.get("TargetDate")&&r.get("TargetDate").getTime()<t.getTime()&&r.get("TargetDate").getTime()>e.getTime()&&r.get("c_Type")===this._milestoneType)return r},i):this._milestoneComboStore.filterBy(function(e){return e}):this._milestoneComboStore.filterBy(function(e){if(e.get("c_Type")&&e.get("c_Type")===this._milestoneType)return e},i):this._milestoneComboStore.filterBy(function(e){if(e.get("TargetDate")&&e.get("TargetDate").getTime()<t.getTime())return e},i):this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()>e.getTime())return t},i)},_setFilter:function(e){this._filters=[{property:"Milestones",operator:"contains",value:e}],this._buildBoard()},_buildBoard:function(){if(void 0!==this._filters){this.setLoading(),void 0!==this._cardBoard&&this.down("#bodyContainer").remove(this._cardBoard);var e=this.getContext();this._cardBoard=Ext.widget("rallygridboard",{types:this._types,itemId:"cardboard",name:"cardboard",context:e,toggleState:"board",stateful:!1,listeners:{load:function(e,t){this.setLoading(!1)},scope:this},storeConfig:{filters:this._filters},cardBoardConfig:{attribute:"State",columnConfig:{columnStatusConfig:{pointField:"PreliminaryEstimateValue"},fields:this._getDefaultFields()},rowConfig:{field:"Project"}},plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{margin:"3 9 3 30",stateful:!0,stateId:e.getScopedStateId("filters"),modelNames:["PortfolioItem/Feature"],inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner","State"]}}}}]}),this.down("#bodyContainer").add(this._cardBoard)}},_buildMilestoneColumn:function(e){var t=Ext.create("Deft.Deferred"),r=e.get("TargetDate"),i=e.get("ObjectID"),o=e.get("_ref"),a=e.get("Name"),n="milestone-"+i,s=r.toLocaleDateString(),l=Ext.create("Ext.panel.Panel",{title:"Target Date: "+s,width:320,layout:{type:"vbox",padding:5},padding:5,itemId:n}),d={property:"Milestones",operator:"contains",value:o};return this.down("#extraFilters").value&&(console.log("using extraFilters"),this._filterPlannedStartDate&&(d=Rally.data.QueryFilter.and([d,{property:"PlannedStartDate",operator:">=",value:this._filterPlannedStartDate}])),this._filterPlannedEndDate&&(d=Rally.data.QueryFilter.and([d,{property:"PlannedEndDate",operator:"<=",value:this._filterPlannedEndDate}])),this._filterProject&&(d=Rally.data.QueryFilter.and([d,{property:"Project.Name",value:this._filterProject}])),this._filterParent&&(d=Rally.data.QueryFilter.and([d,{property:"Parent.Name",operator:"contains",value:this._filterParent}])),this._filterParentFormattedID&&(d=Rally.data.QueryFilter.and([d,{property:"Parent.FormattedID",operator:"=",value:this._filterParentFormattedID}]))),console.log("filter:",d),Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature","Defect","TestSet"],fetch:["FormattedID","Name","Owner","ObjectID","Project","State","Type","Tags","Parent","Requirement","PlanEstimate","PreliminaryEstimateValue","LeafStoryPlanEstimateTotal","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate","c_BusinessPriority","DisplayColor","WSJFScore"],filters:[d],limit:1/0}).load().then({success:function(e){console.log("records",e);var r=this;if(e){var o=this._createBPColumnSorter(n);l.add(o);var s=this._createWSJFColumnSorter(n);l.add(s);var d=this._buildSummaryCard(a,e);l.add(d);var c={milestoneName:a,milestoneId:i,featuresArray:[]};_.each(e,function(e){var t,i,o;l.add(r._buildKanbanCard(e)),"portfolioitem/feature"==e.get("_type")?(t=e.get("LeafStoryPlanEstimateTotal"),i=e.get("Parent").Name,o=e.get("PreliminaryEstimateValue")):(t=e.get("PlanEstimate"),i=e.get("Requirement")?e.get("Requirement").Name:"",o="");var a={id:e.get("FormattedID"),description:e.get("Name"),planEstimate:t,parent:i,project:e.get("Project").Name,score:e.get("WSJFScore"),businessPriority:e.get("c_BusinessPriority"),preliminaryEstimateValue:o};c.featuresArray.push(a)},r),this._exportData.add(i,c)}t.resolve()},scope:this}),this.down("#bodyContainer").add(l),t.promise},_createBPColumnSorter:function(e){return new Ext.panel.Panel({width:110,height:22,id:e+"sorter1",html:"Business Priority &#x2B06;&#x2B07; ",baseCls:"custom-cursor",order:!0,listeners:{render:function(t){t.getEl().on({click:function(){var r=Ext.ComponentQuery.query("#"+e)[0],i=this._sortItemsByBusinessPriority(r.items,t.order);t.order=!t.order;var o=r.items.getAt(0),a=r.items.getAt(1),n=r.items.getAt(2);r.removeAll(!1),r.add(o),r.add(a),r.add(n),r.add(i),r.doLayout()},scope:this})},afterrender:function(){Ext.QuickTips.init(),Ext.QuickTips.register({target:e+"sorter1",text:"Sort cards based on Business Priority",width:240,dismissDelay:2e3})},destroy:function(){Ext.QuickTips.destroy()},scope:this}})},_sortItemsByBusinessPriority:function(e,t){for(var r=[],i=3;i<e.length;i++)r.push(e.getAt(i));return t?r.sort(function(e,t){var r=e.getRecord().get("c_BusinessPriority"),i=t.getRecord().get("c_BusinessPriority");return r<i?-1:r>i?1:0}):r.sort(function(e,t){var r=e.getRecord().get("c_BusinessPriority"),i=t.getRecord().get("c_BusinessPriority");return r>i?-1:r<i?1:0})},_createWSJFColumnSorter:function(e){return new Ext.panel.Panel({width:45,height:22,id:e+"sorter2",html:"WSJF &#x2B06;&#x2B07;",baseCls:"custom-cursor",order:!0,listeners:{render:function(t){t.getEl().on({click:function(){var r=Ext.ComponentQuery.query("#"+e)[0],i=this._sortItemsByWSJFScore(r.items,t.order);t.order=!t.order;var o=r.items.getAt(0),a=r.items.getAt(1),n=r.items.getAt(2);r.removeAll(!1),r.add(o),r.add(a),r.add(n),r.add(i),r.doLayout()},scope:this})},afterrender:function(){Ext.QuickTips.init(),Ext.QuickTips.register({target:e+"sorter2",text:"Sort cards based on WSJF",width:180,dismissDelay:2e3})},destroy:function(){Ext.QuickTips.destroy()},scope:this}})},_sortItemsByWSJFScore:function(e,t){for(var r=[],i=3;i<e.length;i++)r.push(e.getAt(i));return t?r.sort(function(e,t){var r=e.getRecord().get("WSJFScore"),i=t.getRecord().get("WSJFScore");return r<i?-1:r>i?1:0}):r.sort(function(e,t){var r=e.getRecord().get("WSJFScore"),i=t.getRecord().get("WSJFScore");return r>i?-1:r<i?1:0})},_buildSummaryCard:function(e,t){var r=0,i=0,o=0;return _.each(t,function(e){"portfolioitem/feature"==e.get("_type")?(r+=e.get("PreliminaryEstimateValue"),i+=e.get("LeafStoryPlanEstimateTotal")):o+=e.get("PlanEstimate")}),Ext.widget("propertygrid",{title:e+" summary:",hideHeaders:!0,nameColumnWidth:200,padding:"0 0 20 15",width:280,source:{"Total Feature Pts":r,"Total Leaf Story Pts":i,"Total Defect PTs":o}})},_buildKanbanCard:function(e){return Ext.widget("rallycard",{itemId:e.get("FormattedID"),config:{record:e},fields:["Name","Owner","FormattedID","Tags","Project","Parent","LeafStoryPlanEstimateTotal","PercentDoneByStoryPlanEstimate","c_BusinessPriority","WSJFScore"],width:280,record:e})},_buildSummaryBoard:function(e){var t,r=[];for(var i of e)r.push(i.get("_ref"));if(1==r.length)t={property:"Milestones",operator:"contains",value:r[0]};else if(2==r.length)t=Rally.data.wsapi.Filter.or([{property:"Milestones",operator:"contains",value:r[0]},{property:"Milestones",operator:"contains",value:r[1]}]);else if(r.length>2)for(var o of(t=Rally.data.wsapi.Filter.or([{property:"Milestones",operator:"contains",value:r[0]},{property:"Milestones",operator:"contains",value:r[1]}]),r=_.last(r,r.length-2)))t=Rally.data.wsapi.Filter.or([t,{property:"Milestones",operator:"contains",value:o}]);Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","Project","State","LeafStoryPlanEstimateTotal"],filters:t,limit:1/0}).load().then({success:function(e){var t=new Ext.util.MixedCollection,r=[],i=[],o={ProjectName:"LeafStoryPlanEstimateTotal"};_.each(e,function(e){var r=e.get("Project").Name;if(t.containsKey(r)){var i=t.get(r);i+=e.get("LeafStoryPlanEstimateTotal"),t.replace(r,i)}else{var o=e.get("LeafStoryPlanEstimateTotal");t.add(r,o)}}),t.eachKey(function(e,t){r.push({text:e,dataIndex:e}),i.push(e),o[e]=t});var a=Ext.create("Ext.grid.Panel",{columns:r,flex:1,store:{fields:i,data:o}});this.down("#summaryPanel").removeAll(!0),this.down("#summaryPanel").add(a)},scope:this})},_getDefaultFields:function(){return["Discussion","PreliminaryEstimate","UserStories","Milestones"]},_convertToCSV:function(e){var t=Object.keys(e[0]),r=function(e,t){return null===t?"":t},i=e.map(function(e){return t.map(function(t){return JSON.stringify(e[t],r)}).join(",")});return i.unshift(t.join(",")),i.join("\r\n")},_convertExportDataToJson:function(e){var t=[];return e.eachKey(function(e,r){var i=r.milestoneName;_.each(r.featuresArray,function(e){t.push({milestoneName:i,featureNumber:e.id,featureDescription:e.description,planEstimate:e.planEstimate,parent:e.parent,project:e.project,score:e.score,businessPriority:e.businessPriority,preliminaryEstimateValue:e.preliminaryEstimateValue})},this)},this),t}});

            Rally.launchApp('CustomApp', {
                name:"S484983-MilestonePlanningReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        .custom-cursor{background-position:right center;background-repeat:no-repeat;float:left;position:static !important;margin:0px 0px 0px 50px !important}.custom-cursor-body{border-width:1px;border-style:solid;border-radius:2px;background-color:#fafafa}
    </style>
</head>
<body>
</body>
</html>
