<!DOCTYPE html>
<html>
<head>
    <title>S484983-MilestonePlanningReport</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",requires:["Rally.ui.gridboard.plugin.GridBoardCustomFilterControl"],_cardBoard:void 0,_filters:void 0,_types:["PortfolioItem/Feature"],_initDate:void 0,_endDate:void 0,_exportData:void 0,_exportButton:void 0,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",layout:{type:"hbox"},height:"90%",width:"100%",autoScroll:!0}],launch:function(){var t=this.getContext().getProject().ObjectID;this.projectId=t,this._milestoneComboStore=void 0,console.log("project:",t),this._milestoneCombo=Ext.widget("rallymilestonecombobox",{itemId:"milestonecombobox",allowClear:!0,multiSelect:!0,width:300,listeners:{change:function(t){if(console.log("change: ",t.getValue()),t.getValue()&&""!=t.getValue()&&t.valueModels.length>0){this.setLoading();var e=t.valueModels;e.sort(function(t,e){return t.get("TargetDate").getTime()-e.get("TargetDate").getTime()}),this.down("#bodyContainer").removeAll(!0),this._exportData=new Ext.util.MixedCollection;var o=[];for(var i of e)o.push(this._buildMilestoneColumn(i));Deft.Promise.all(o).then({success:function(t){this.setLoading(!1);var e=this._convertExportDataToJson(this._exportData);this._exportButton?(this.down("#header").remove(this._exportButton),this._exportButton=this._createExportButton(e),this.down("#header").add(this._exportButton)):(this._exportButton=this._createExportButton(e),this.down("#header").add(this._exportButton))},scope:this})}},ready:function(t){},scope:this}}),this._milestoneComboStore=this._milestoneCombo.getStore(),this.down("#header").add([{xtype:"panel",autoWidth:!0,height:120,layout:"hbox",items:[{xtype:"panel",title:"Choose date range for milestone:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"datefield",anchor:"100%",fieldLabel:"From",scope:this,listeners:{change:function(t,e,o){this._initDate=e;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}},{xtype:"datefield",anchor:"100%",fieldLabel:"To",scope:this,listeners:{change:function(t,e,o){this._endDate=e;this._applyMilestoneRangeFilter(this._initDate,this._endDate,this._milestoneComboStore,this)},scope:this}}]}]},{xtype:"fieldcontainer",fieldLabel:"Milestone",pack:"end",labelAlign:"right",items:[this._milestoneCombo]}])},_createExportButton:function(t){return Ext.create("Rally.ui.Button",{text:"Export",margin:"10 10 10 10",scope:this,handler:function(){var e=this._convertToCSV(t);console.log("converting to csv:",e);var o=document.createElement("a"),i=new Blob(["\ufeff",e]),a=URL.createObjectURL(i);o.href=a,o.download="report.csv",document.body.appendChild(o),o.click(),document.body.removeChild(o)}})},_applyMilestoneRangeFilter:function(t,e,o,i){t&&!e?this._milestoneComboStore.filterBy(function(e){if(e.get("TargetDate")&&e.get("TargetDate").getTime()>t.getTime())return e},i):e&&!t?this._milestoneComboStore.filterBy(function(t){if(t.get("TargetDate")&&t.get("TargetDate").getTime()<e.getTime())return t},i):t&&e?this._milestoneComboStore.filterBy(function(o){if(o.get("TargetDate")&&o.get("TargetDate").getTime()>t.getTime()&&o.get("TargetDate").getTime()<e.getTime())return o},i):this._milestoneComboStore.filterBy(function(t){return t})},_setFilter:function(t){this._filters=[{property:"Milestones",operator:"contains",value:t}],this._buildBoard()},_buildBoard:function(){if(void 0!==this._filters){this.setLoading(),void 0!==this._cardBoard&&this.down("#bodyContainer").remove(this._cardBoard);var t=this.getContext();this._cardBoard=Ext.widget("rallygridboard",{types:this._types,itemId:"cardboard",name:"cardboard",context:t,toggleState:"board",stateful:!1,listeners:{load:function(t,e){this.setLoading(!1)},scope:this},storeConfig:{filters:this._filters},cardBoardConfig:{attribute:"State",columnConfig:{columnStatusConfig:{pointField:"PreliminaryEstimateValue"},fields:this._getDefaultFields()},rowConfig:{field:"Project"}},plugins:[{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{margin:"3 9 3 30",stateful:!0,stateId:t.getScopedStateId("filters"),modelNames:["PortfolioItem/Feature"],inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner","State"]}}}}]}),this.down("#bodyContainer").add(this._cardBoard)}},_buildMilestoneColumn:function(t){var e=Ext.create("Deft.Deferred"),o=t.get("TargetDate"),i=t.get("ObjectID"),a=t.get("_ref"),r=t.get("Name"),n="milestone-"+i,l=o.toLocaleDateString(),s=Ext.create("Ext.panel.Panel",{title:"Target Date: "+l,width:320,layout:{type:"vbox",padding:5},padding:5,itemId:n}),d={property:"Milestones",operator:"contains",value:a};return Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature","Defect","TestSet"],fetch:["FormattedID","Name","Owner","ObjectID","Project","State","Type","PlanEstimate","PreliminaryEstimateValue","LeafStoryPlanEstimateTotal","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate"],filters:[d],limit:1/0}).load().then({success:function(t){var o=this;if(t){var a=this._buildSummaryCard(r,t);s.add(a);var n={milestoneName:r,milestoneId:i,featuresArray:[]};_.each(t,function(t){var e;s.add(o._buildKanbanCard(t)),e="portfolioitem/feature"==t.get("_type")?t.get("LeafStoryPlanEstimateTotal"):t.get("PlanEstimate");var i={id:t.get("FormattedID"),description:t.get("Name"),planEstimate:e};n.featuresArray.push(i)},o),this._exportData.add(i,n)}e.resolve()},scope:this}),this.down("#bodyContainer").add(s),e.promise},_buildSummaryCard:function(t,e){var o=0,i=0,a=0;return _.each(e,function(t){"portfolioitem/feature"==t.get("_type")?(o+=t.get("PreliminaryEstimateValue"),i+=t.get("LeafStoryPlanEstimateTotal")):a+=t.get("PlanEstimate")}),Ext.widget("propertygrid",{title:t+" summary:",hideHeaders:!0,nameColumnWidth:200,padding:"0 0 20 15",width:280,source:{"Total Feature Pts":o,"Total Leaf Story Pts":i,"Total Defect PTs":a}})},_buildKanbanCard:function(t){return Ext.widget("rallycard",{itemId:t.get("FormattedID"),config:{record:t},fields:["Name","Owner","FormattedID","Tags","Project","Parent","LeafStoryPlanEstimateTotal","PercentDoneByStoryPlanEstimate"],width:280,record:t})},_buildSummaryBoard:function(t){var e,o=[];for(var i of t)o.push(i.get("_ref"));if(1==o.length)e={property:"Milestones",operator:"contains",value:o[0]};else if(2==o.length)e=Rally.data.wsapi.Filter.or([{property:"Milestones",operator:"contains",value:o[0]},{property:"Milestones",operator:"contains",value:o[1]}]);else if(o.length>2)for(var a of(e=Rally.data.wsapi.Filter.or([{property:"Milestones",operator:"contains",value:o[0]},{property:"Milestones",operator:"contains",value:o[1]}]),o=_.last(o,o.length-2)))e=Rally.data.wsapi.Filter.or([e,{property:"Milestones",operator:"contains",value:a}]);Ext.create("Rally.data.wsapi.artifact.Store",{context:{projectScopeUp:!1,projectScopeDown:!0,project:null},models:["PortfolioItem/Feature"],fetch:["FormattedID","Name","ObjectID","Project","State","LeafStoryPlanEstimateTotal"],filters:e,limit:1/0}).load().then({success:function(t){var e=new Ext.util.MixedCollection,o=[],i=[],a={ProjectName:"LeafStoryPlanEstimateTotal"};_.each(t,function(t){var o=t.get("Project").Name;if(e.containsKey(o)){var i=e.get(o);i+=t.get("LeafStoryPlanEstimateTotal"),e.replace(o,i)}else{var a=t.get("LeafStoryPlanEstimateTotal");e.add(o,a)}}),e.eachKey(function(t,e){o.push({text:t,dataIndex:t}),i.push(t),a[t]=e});var r=Ext.create("Ext.grid.Panel",{columns:o,flex:1,store:{fields:i,data:a}});this.down("#summaryPanel").removeAll(!0),this.down("#summaryPanel").add(r)},scope:this})},_getDefaultFields:function(){return["Discussion","PreliminaryEstimate","UserStories","Milestones"]},_convertToCSV:function(t){var e=Object.keys(t[0]),o=function(t,e){return null===e?"":e},i=t.map(function(t){return e.map(function(e){return JSON.stringify(t[e],o)}).join(",")});return i.unshift(e.join(",")),i.join("\r\n")},_convertExportDataToJson:function(t){var e=[];return t.eachKey(function(t,o){var i=o.milestoneName;_.each(o.featuresArray,function(t){e.push({milestoneName:i,featureNumber:t.id,featureDescription:t.description,planEstimate:t.planEstimate})},this)},this),e}});

            Rally.launchApp('CustomApp', {
                name:"S484983-MilestonePlanningReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
